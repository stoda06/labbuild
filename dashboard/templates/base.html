<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}LabBuild Dashboard{% endblock %}</title>
    {% block head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" ...>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" ...>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% endblock %}
  </head>
  {# Apply class server-side based on cookie #}
  <body class="{{ 'dark-mode' if current_theme == 'dark' else '' }}">

    {# --- Top Navbar --- #}
    <nav class="navbar">
      <div class="container-fluid">
        {# Navbar Brand on the left #}
        <a class="navbar-brand" href="{{ url_for('main.index') }}">LabBuild Dashboard</a>

        {# Main Navbar Links - centered or to the left of settings icon #}
        <div class="navbar-links mx-auto d-none d-lg-flex"> {# mx-auto to center if space allows, or adjust #}
             <a href="{{ url_for('main.index') }}" class="nav-link">Dashboard</a>
             <a href="{{ url_for('main.view_allocations') }}" class="nav-link">Allocations</a>
             <a href="{{ url_for('main.view_upcoming_courses') }}" class="nav-link">Upcoming Courses</a>
             <a href="{{ url_for('main.terminal') }}" class="nav-link">Terminal</a>
        </div>

        {# --- Settings (Sidebar Toggle) Button - MOVED TO THE RIGHT --- #}
        <button class="btn btn-outline-secondary ms-auto" type="button" id="sidebarToggle" title="Toggle Settings">
            <i class="fas fa-cog"></i> {# CHANGED ICON to Gear #}
        </button>
      </div>
    </nav>
    {# --- Sidebar (Initially Hidden) --- #}
    <div class="sidebar" id="settingsSidebar">
        <div class="sidebar-header">
            <h5>Settings</h5>
            <button type="button" class="btn-close btn-close-white" id="sidebarClose" aria-label="Close"></button>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('settings.view_build_rules') }}">
                    <i class="fas fa-cogs me-2"></i>Build Rules
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('settings.view_course_configs') }}"> {# New route #}
                    <i class="fas fa-book-open me-2"></i>Course Configurations
                </a>
            </li>
            {# --- Dark Mode Toggle MOVED INTO SIDEBAR --- #}
            <li class="nav-item">
                <a class="nav-link" href="#" id="darkModeToggleSidebar" title="Toggle light/dark mode">
                     <i class="fas me-2"></i> {# Icon will be set by JS #}
                     <span id="darkModeToggleSidebarText">Toggle Mode</span>
                </a>
            </li>
            {# --- End Dark Mode Toggle --- #}
        </ul>
         {# Links for smaller screens, mirroring navbar-links #}
        <hr class="d-lg-none">
        <div class="sidebar-bottom-links d-lg-none">
             <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.index') }}"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.view_allocations') }}"><i class="fas fa-tasks me-2"></i>Allocations</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.view_upcoming_courses') }}"><i class="fas fa-calendar-alt me-2"></i>Upcoming Courses</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.terminal') }}"><i class="fas fa-terminal me-2"></i>Terminal</a></li>
             </ul>
        </div>
    </div>
    {# --- End Sidebar --- #}

    {# --- Main Content Area (Pushes over when sidebar is open) --- #}
    <div class="main-content" id="mainContent">
        <main class="container mt-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="position-relative" style="z-index: 1050;">
                {% for category, message in messages %}
                  <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                    {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    {% block scripts %}
    {# --- Dark Mode JS (Cookie Version) --- #}
    <script>
      // Elements for dark mode toggle (now potentially in sidebar)
      const darkModeButtonSidebar = document.getElementById('darkModeToggleSidebar'); // New ID for sidebar toggle
      const body = document.body;

      function updateDarkModeVisuals() {
          const isDarkMode = body.classList.contains('dark-mode');
          if (darkModeButtonSidebar) { // Check if sidebar toggle exists
              const iconElement = darkModeButtonSidebar.querySelector('i.fas');
              const textElement = darkModeButtonSidebar.querySelector('span');
              if (iconElement) {
                  iconElement.className = 'fas me-2 '; // Base classes
                  iconElement.classList.add(isDarkMode ? 'fa-sun' : 'fa-moon');
              }
              if (textElement) {
                  textElement.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
              }
          }
      }

      // Set initial state based on cookie/body class
      document.addEventListener('DOMContentLoaded', updateDarkModeVisuals);

      if (darkModeButtonSidebar) {
          darkModeButtonSidebar.addEventListener('click', (event) => {
              event.preventDefault(); // Prevent navigation if it's an <a> tag
              body.classList.toggle('dark-mode');
              const isDarkMode = body.classList.contains('dark-mode');
              const newMode = isDarkMode ? 'dark' : 'light';
              const maxAge = 365 * 24 * 60 * 60;
              document.cookie = `theme=${newMode}; path=/; max-age=${maxAge}; SameSite=Lax`;
              updateDarkModeVisuals(); // Update icon and text
              // Optional: Add rotation if icon element exists
              const iconElement = darkModeButtonSidebar.querySelector('i.fas');
              if (iconElement) {
                  iconElement.classList.add('rotate');
                  setTimeout(() => { iconElement.classList.remove('rotate'); }, 500);
              }
          });
      }
  </script>

    {# --- Client-side Timezone Conversion JS --- #}
    <script>
        function formatLocalDateTime(isoString) {
            if (!isoString) return 'N/A';
            try { const date = new Date(isoString); if (isNaN(date.getTime())) return 'Invalid Date'; const options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true, timeZoneName: 'short' }; return new Intl.DateTimeFormat(undefined, options).format(date); } catch (e) { console.error("Fmt date err:", isoString, e); return 'Invalid Date'; }
         }
        function updateLocalTimes() {
            document.querySelectorAll('.local-datetime').forEach(span => { const isoTimestamp = span.dataset.timestamp; if (isoTimestamp && !span.classList.contains('js-formatted-time')) { span.textContent = formatLocalDateTime(isoTimestamp); span.classList.add('js-formatted-time'); } else if (!isoTimestamp && !span.classList.contains('js-formatted-time')) { span.textContent = 'N/A'; span.classList.add('js-formatted-time'); } });
         }
        document.addEventListener('DOMContentLoaded', updateLocalTimes); // Run on initial load
    </script>
    {# --- NEW Sidebar Toggle JS --- #}
    {# --- Sidebar Toggle JS (Logic is the same) --- #}
    <script>
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const settingsSidebar = document.getElementById('settingsSidebar');
        const mainContent = document.getElementById('mainContent');
        const bodyElement = document.body;

        function openSidebar() {
            if (settingsSidebar) settingsSidebar.classList.add('open');
            if (mainContent) mainContent.classList.add('shifted');
            if (bodyElement) bodyElement.classList.add('sidebar-open-no-scroll');
        }

        function closeSidebar() {
            if (settingsSidebar) settingsSidebar.classList.remove('open');
            if (mainContent) mainContent.classList.remove('shifted');
            if (bodyElement) bodyElement.classList.remove('sidebar-open-no-scroll');
        }

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                if (settingsSidebar && settingsSidebar.classList.contains('open')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
        }
        if (sidebarClose) {
            sidebarClose.addEventListener('click', closeSidebar);
        }

        document.addEventListener('click', function(event) {
            if (settingsSidebar && settingsSidebar.classList.contains('open')) {
                const isClickInsideSidebar = settingsSidebar.contains(event.target);
                const isClickOnToggle = sidebarToggle ? sidebarToggle.contains(event.target) : false;
                if (!isClickInsideSidebar && !isClickOnToggle) {
                    closeSidebar();
                }
            }
        });
    </script>
    {% endblock %}
  </body>
</html>