<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}LabBuild Dashboard{% endblock %}</title>
    {% block head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" ...>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" ...>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% endblock %}
  </head>
  {# Apply class server-side based on cookie #}
  <body class="{{ 'dark-mode' if current_theme == 'dark' else '' }}">

    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">LabBuild Dashboard</a>
        {# --- Add Allocations Link --- #}
        <div class="navbar-links">
             <a href="{{ url_for('main.view_allocations') }}" class="nav-link">Allocations</a>
             <a href="{{ url_for('main.view_upcoming_courses') }}" class="nav-link">Upcoming Courses</a>
             <a href="{{ url_for('main.terminal') }}" class="nav-link">Terminal</a> {# Link to terminal if you kept it #}
             <a href="{{ url_for('settings.view_build_rules') }}" class="nav-link">Settings</a>
             {# Add other links here if needed #}
        </div>
        {# --- End Allocations Link --- #}
        <button class="toggle-mode ms-auto" id="darkModeToggle" title="Toggle light/dark mode">
            <i class="fas"></i> {# Icon set by JS below #}
        </button>
      </div>
    </nav>

    <main class="container mt-4">
        {# Flash Messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="position-relative" style="z-index: 1050;">
            {% for category, message in messages %}
              <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    {% block scripts %}
    {# --- Dark Mode JS (Cookie Version) --- #}
    <script>
        const toggleButton = document.getElementById('darkModeToggle');
        const body = document.body;
        const icon = toggleButton.querySelector('i');

        function updateIcon() {
            if (body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
            }
        }
        document.addEventListener('DOMContentLoaded', updateIcon); // Set initial icon

        toggleButton.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            const newMode = isDarkMode ? 'dark' : 'light';
            const maxAge = 365 * 24 * 60 * 60;
            document.cookie = `theme=${newMode}; path=/; max-age=${maxAge}; SameSite=Lax`;
            updateIcon(); // Update icon on toggle
            icon.classList.add('rotate'); setTimeout(() => { icon.classList.remove('rotate'); }, 500);
        });
    </script>

    {# --- Client-side Timezone Conversion JS --- #}
    <script>
        function formatLocalDateTime(isoString) {
            if (!isoString) return 'N/A';
            try { const date = new Date(isoString); if (isNaN(date.getTime())) return 'Invalid Date'; const options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true, timeZoneName: 'short' }; return new Intl.DateTimeFormat(undefined, options).format(date); } catch (e) { console.error("Fmt date err:", isoString, e); return 'Invalid Date'; }
         }
        function updateLocalTimes() {
            document.querySelectorAll('.local-datetime').forEach(span => { const isoTimestamp = span.dataset.timestamp; if (isoTimestamp && !span.classList.contains('js-formatted-time')) { span.textContent = formatLocalDateTime(isoTimestamp); span.classList.add('js-formatted-time'); } else if (!isoTimestamp && !span.classList.contains('js-formatted-time')) { span.textContent = 'N/A'; span.classList.add('js-formatted-time'); } });
         }
        document.addEventListener('DOMContentLoaded', updateLocalTimes); // Run on initial load
    </script>
    {% endblock %}
  </body>
</html>