{# dashboard/templates/trainer_pod_review.html #}
{% extends 'base.html' %}

{% block title %}Review Trainer Pod Allocation{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .review-table th, .review-table td { 
            font-size: 0.85rem; 
            vertical-align: middle; 
        }
        .assignment-warning-text { 
            font-style: italic; 
            color: var(--bs-warning); 
            font-size: 0.8em;
            display: block;
            margin-top: 0.2rem;
        }
        body.dark-mode .assignment-warning-text { color: var(--status-warning-dark-text); }
        
        .col-sf-code { width: 150px; } 
        .col-lb-course { width: 140px; }
        .col-vendor { width: 50px; text-align: center; }
        .col-student-assignments-display { min-width: 240px; white-space: normal; font-size: 0.8em;}
        .col-trainer-build-toggle { width: 90px; text-align: center; } /* For checkbox */
        .col-interactive-assignments-trainer { min-width: 350px; } 
        .col-total-interactive-memory { width: 110px; text-align: right; font-weight: bold; }
         
        .review-table input[type="number"].form-control-sm,
        .review-table select.form-select-sm {
            font-size: 0.75rem; padding: 0.15rem 0.3rem; height: auto; 
            display: inline-block; width: 100%; box-sizing: border-box;
        }
        .review-table td { padding-top: 0.3rem; padding-bottom: 0.3rem; } 
        .table-sm th, .table-sm td { padding: 0.3rem; } 
        .form-control.is-invalid, .form-select.is-invalid { border-color: var(--bs-danger); }

        .assignment-sub-row {
            display: flex; align-items: center; gap: 0.4rem; 
            margin-bottom: 0.25rem; padding: 0.1rem 0; 
        }
        .assignment-sub-row.disabled-inputs select,
        .assignment-sub-row.disabled-inputs input {
            background-color: #e9ecef;
            pointer-events: none;
            opacity: 0.65;
        }
        body.dark-mode .assignment-sub-row.disabled-inputs select,
        body.dark-mode .assignment-sub-row.disabled-inputs input {
            background-color: #3a3a3a;
        }
        .sub-host-select { flex: 2; min-width: 110px; max-width: 140px; } 
        .sub-pod-input { flex: 0.8; min-width: 50px; max-width: 60px; text-align: center;} 
        
        .student-assignment-item { display: block; margin-bottom: 0.2em; font-size: 0.9em;}
        .error-icon-container {
            margin-left: 5px; display: inline-flex; align-items: center;
        }
        .error-icon-container .fa-exclamation-triangle {
            color: var(--bs-warning); cursor: help; 
        }
        body.dark-mode .error-icon-container .fa-exclamation-triangle {
            color: var(--status-warning-dark-text); 
        }
    </style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
   <h1>Review Trainer Pod Allocation (Batch ID: {{ batch_review_id }})</h1>
   <a href="javascript:history.back()" 
      onclick="return confirm('Are you sure? Changes on this page will be lost, returning to student assignments.');" 
      class="btn btn-sm btn-outline-secondary">
      Back to Student Assignments
    </a>
</div>

<div class="card">
    <div class="card-header">Step 2: Assign or Skip Trainer Pods</div>
    <div class="card-body">
        {% if courses_and_trainer_pods %}
            <p>Review student assignments (read-only). For each course, decide if a trainer pod should be built. Adjust host/pod if building.</p>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered review-table" id="trainerReviewTable">
                    <thead class="table-light">
                        <tr>
                            <th class="col-sf-code">SF Course Code</th>
                            <th class="col-lb-course">LabBuild Course</th>
                            <th class="col-vendor">Vendor</th>
                            <th class="col-student-assignments-display">Student Assignments (Finalized)</th>
                            <th class="col-trainer-build-toggle">Build Trainer?</th>
                            <th class="col-interactive-assignments-trainer">Trainer Pod Assignment</th>
                            <th class="col-total-interactive-memory">Trainer Pod Est. Mem (GB)</th> 
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in courses_and_trainer_pods %}
                            {% if item.type == 'student' %}
                                {% set student_course = item.data %}
                                <tr class="table-secondary student-data-row" style="font-style: italic;">
                                    <td class="col-sf-code" title="{{ student_course.sf_course_code }}">{{ student_course.sf_course_code }}</td>
                                    <td class="col-lb-course" title="{{ student_course.labbuild_course }}">{{ student_course.labbuild_course }}</td>
                                    <td class="col-vendor">{{ student_course.vendor | upper if student_course.vendor else 'N/A' }}</td>
                                    <td class="col-student-assignments-display">
                                        {% if student_course.interactive_assignments %}
                                            {% for assignment in student_course.interactive_assignments %}
                                                <span class="student-assignment-item">
                                                    <strong>Host:</strong> {{ assignment.host or 'N/A' }}, 
                                                    <strong>Pods:</strong> {{ assignment.start_pod or '?' }}-{{ assignment.end_pod or '?' }}
                                                </span>
                                            {% endfor %}
                                            {% if student_course.assignment_warning %} {# Display student assignment warnings #}
                                                <small class="d-block text-warning mt-1 fst-italic">{{ student_course.assignment_warning }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No student assignments.</span>
                                        {% endif %}
                                    </td>
                                    <td class="col-trainer-build-toggle text-muted"></td>
                                    <td class="col-interactive-assignments-trainer text-muted">N/A (Student Info)</td>
                                    <td class="col-total-interactive-memory text-muted text-end">
                                        {{ "%.2f"|format(student_course.estimated_memory_gb | default(0.0) | float )}} GB
                                    </td> 
                                </tr>
                            {% elif item.type == 'trainer' %}
                                {% set trainer_pod = item.data %}
                                <tr class="trainer-data-row" 
                                    data-interim-doc-id="{{ trainer_pod.interim_doc_id }}" {# ID of the parent interim doc #}
                                    data-labbuild-course="{{ trainer_pod.labbuild_course or '' }}" 
                                    data-memory-one-pod="{{ trainer_pod.memory_gb_one_pod | default(0.0) }}"
                                    data-sf-course-code-trainer="{{ trainer_pod.sf_course_code }}"
                                    data-vendor="{{ trainer_pod.vendor | lower if trainer_pod.vendor else '' }}">

                                    <td class="col-sf-code" title="{{ trainer_pod.sf_course_code }}">
                                        <strong>{{ trainer_pod.sf_course_code }}</strong>
                                    </td>
                                    <td class="col-lb-course" title="{{ trainer_pod.labbuild_course or 'N/A' }}">{{ trainer_pod.labbuild_course or 'N/A' }}</td>
                                    <td class="col-vendor">{{ trainer_pod.vendor | upper if trainer_pod.vendor else 'N/A'}}</td>
                                    <td class="col-student-assignments-display text-muted">N/A (Trainer Assignment)</td>
                                    
                                    <td class="col-trainer-build-toggle">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input build-trainer-checkbox" type="checkbox" 
                                                   value="yes" id="build_trainer_{{ loop.index0 }}"
                                                   {% if not (trainer_pod.error_message and ("Disabled by Rule" in trainer_pod.error_message or "No LabBuild course" in trainer_pod.error_message or "Memory for TP LB course" in trainer_pod.error_message and "is 0" in trainer_pod.error_message) ) %}
                                                       checked 
                                                   {% endif %}
                                                   {% if trainer_pod.error_message and ("Disabled by Rule" in trainer_pod.error_message or "No LabBuild course" in trainer_pod.error_message or "Memory for TP LB course" in trainer_pod.error_message and "is 0" in trainer_pod.error_message) %}
                                                       disabled title="{{trainer_pod.error_message}}"
                                                   {% endif %}>
                                        </div>
                                    </td>

                                    <td class="col-interactive-assignments-trainer interactive-assignments-cell">
                                        <div class="assignment-sub-row {% if trainer_pod.error_message and ('Disabled by Rule' in trainer_pod.error_message or 'No LabBuild course' in trainer_pod.error_message or ('Memory for TP LB course' in trainer_pod.error_message and 'is 0' in trainer_pod.error_message)) %}disabled-inputs{% endif %}">
                                            <select name="host_assignment_tp_{{ loop.index0 }}" 
                                                    class="form-select form-select-sm sub-host-select">
                                                <option value="">-- Host --</option>
                                                {% for host_name_opt_tp in all_hosts %}
                                                <option value="{{ host_name_opt_tp }}" {% if trainer_pod.assigned_host == host_name_opt_tp %}selected{% endif %}>
                                                    {{ host_name_opt_tp }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <input type="number" name="start_pod_tp_{{ loop.index0 }}" 
                                                   class="form-control form-control-sm sub-pod-input start-pod-input" 
                                                   value="{{ trainer_pod.start_pod | default(1) }}" min="1" placeholder="Pod #">
                                            <input type="number" name="end_pod_tp_{{ loop.index0 }}" 
                                                   class="form-control form-control-sm sub-pod-input end-pod-input" 
                                                   value="{{ trainer_pod.start_pod | default(1) }}" min="1" readonly 
                                                   title="End pod is same as start for a single trainer pod">
                                            {% if trainer_pod.error_message and not ("Disabled by Rule" in trainer_pod.error_message or "No LabBuild course" in trainer_pod.error_message or ("Memory for TP LB course" in trainer_pod.error_message and "is 0" in trainer_pod.error_message)) %}
                                                <span class="error-icon-container" title="{{trainer_pod.error_message}}">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </span>
                                            {% endif %}
                                        </div>
                                         {% if trainer_pod.error_message and ("Disabled by Rule" in trainer_pod.error_message or "No LabBuild course" in trainer_pod.error_message or ("Memory for TP LB course" in trainer_pod.error_message and "is 0" in trainer_pod.error_message)) %}
                                            <small class="text-muted fst-italic">{{trainer_pod.error_message}}</small>
                                        {% endif %}
                                    </td>
                                    <td class="col-total-interactive-memory text-end">
                                        <span class="total-course-memory-display">
                                            {% if trainer_pod.error_message and ("Disabled by Rule" in trainer_pod.error_message or "No LabBuild course" in trainer_pod.error_message or ("Memory for TP LB course" in trainer_pod.error_message and "is 0" in trainer_pod.error_message)) %}N/A
                                            {% else %}0.00{% endif %}
                                        </span> GB
                                    </td> 
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-4">
                <form action="{{ url_for('actions.finalize_and_display_build_plan') }}" method="POST" id="finalizeAndProceedForm">
                     <input type="hidden" name="batch_review_id" value="{{ batch_review_id }}">
                     <input type="hidden" name="final_trainer_assignments_for_review" id="finalTrainerAssignmentsInput">
                     
                     <button type="submit" class="btn btn-lg btn-primary">
                         <i class="fas fa-check-double"></i> Finalize Trainer Assignments & Proceed
                     </button>
                     <a href="{{ url_for('main.view_upcoming_courses') }}" 
                        onclick="return confirm('Are you sure? All progress in this batch review will be lost.');"
                        class="btn btn-lg btn-secondary ms-2">
                        Cancel Batch
                    </a>
                </form>
            </div>
        {% else %}
            <div class="alert alert-warning"> No course data available for trainer pod allocation. Batch ID: {{ batch_review_id or "Unknown" }}</div>
             <a href="{{ url_for('main.view_upcoming_courses') }}" class="btn btn-secondary">Back to Upcoming Courses</a>
        {% endif %}
    </div> 
</div> 

{# Embedded data for JavaScript #}
<script id="allHostsDataTrainer" type="application/json">{{ all_hosts | tojson | safe }}</script>
<script id="courseMemoryDataTrainer" type="application/json">{{ course_configs_for_memory | tojson | safe }}</script>
<script id="memoryFactorDataTrainer" type="application/json">{{ {"factor": subsequent_pod_memory_factor} | tojson | safe }}</script>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const trainerReviewTable = document.getElementById('trainerReviewTable');
        if (!trainerReviewTable) return;

        let COURSE_MEMORY_STORE_TP = [];
        try {
            COURSE_MEMORY_STORE_TP = JSON.parse(document.getElementById('courseMemoryDataTrainer')?.textContent || '[]');
        } catch (e) { console.error("Error parsing courseMemoryDataTrainer JSON:", e); }

        function getLabbuildCourseMemoryTP(lbCourseName) { /* ... same as before ... */ return 0; }
        function calculateAndDisplayTrainerPodMemory(trainerRowEl) { /* ... same as before ... */ return 0; }

        function toggleTrainerInputs(trainerRowElement, enable) {
            const subRow = trainerRowElement.querySelector('.assignment-sub-row');
            const hostSelect = trainerRowElement.querySelector('.sub-host-select');
            const startPodInput = trainerRowElement.querySelector('.start-pod-input');
            const memoryDisplay = trainerRowElement.querySelector('.total-course-memory-display');

            if (subRow) subRow.classList.toggle('disabled-inputs', !enable);
            if (hostSelect) hostSelect.disabled = !enable;
            if (startPodInput) startPodInput.disabled = !enable;
            // End pod input is readonly, so no need to toggle its disabled state directly for interaction,
            // but its value should reflect start_pod or be cleared.

            if (!enable) {
                if (memoryDisplay) memoryDisplay.textContent = "N/A (Skipped)";
                // When unchecking "Build Trainer?", clear the inputs or set to default
                // This ensures no old values are accidentally submitted if re-checked.
                // if (hostSelect) hostSelect.value = ""; 
                // if (startPodInput) startPodInput.value = ""; // Or a default like 1
                // if (trainerRowElement.querySelector('.end-pod-input')) trainerRowElement.querySelector('.end-pod-input').value = "";
            } else {
                // If enabling, recalculate memory (which also validates inputs)
                calculateAndDisplayTrainerPodMemory(trainerRowElement);
            }
        }
        
        trainerReviewTable.querySelectorAll('tbody tr.trainer-data-row').forEach(trainerRow => {
            const buildCheckbox = trainerRow.querySelector('.build-trainer-checkbox');
            const startPodInput = trainerRow.querySelector('.start-pod-input');
            const endPodInput = trainerRow.querySelector('.end-pod-input'); 
            const hostSelect = trainerRow.querySelector('.sub-host-select');
            
            if (buildCheckbox) { // All trainer rows should have this
                // Initial state based on checkbox (checked by default unless rule-disabled)
                if (!buildCheckbox.disabled) { // Only toggle if not rule-disabled
                    toggleTrainerInputs(trainerRow, buildCheckbox.checked); 
                    buildCheckbox.addEventListener('change', function() {
                        toggleTrainerInputs(trainerRow, this.checked);
                    });
                } else { // Rule-disabled, ensure inputs are visually disabled
                     toggleTrainerInputs(trainerRow, false);
                }
            }

            if (startPodInput && endPodInput) { // These listeners are fine even if initially disabled
                startPodInput.addEventListener('input', function() {
                    if (!startPodInput.disabled) { // Only if interactive
                        if (!isNaN(parseInt(this.value,10)) && parseInt(this.value,10) >= 1 ) {
                            endPodInput.value = this.value; 
                        } else { endPodInput.value = ''; }
                        calculateAndDisplayTrainerPodMemory(trainerRow);
                    }
                });
            }
            if (hostSelect) {
                 hostSelect.addEventListener('change', () => {
                     if (!hostSelect.disabled) calculateAndDisplayTrainerPodMemory(trainerRow);
                 });
            }
            calculateAndDisplayTrainerPodMemory(trainerRow); 
        });

        const finalizeAndProceedFormElement = document.getElementById('finalizeAndProceedForm');
        if (finalizeAndProceedFormElement) {
            finalizeAndProceedFormElement.addEventListener('submit', function(event) {
                const finalTrainerAssignments = [];
                let isTrainerFormCompletelyValid = true;

                document.querySelectorAll('#trainerReviewTable tbody tr.trainer-data-row').forEach(trainerRow => {
                    if (!isTrainerFormCompletelyValid) return;

                    const buildCheckbox = trainerRow.querySelector('.build-trainer-checkbox');
                    const interimDocId = trainerRow.dataset.interimDocId;
                    const sfTrainerCode = trainerRow.dataset.sfCourseCodeTrainer;
                    const lbCourse = trainerRow.dataset.labbuildCourse;
                    const vendor = trainerRow.dataset.vendor;
                    const memOnePod = parseFloat(trainerRow.dataset.memoryOnePod);
                    let trainerAssignmentPayload = {
                        interim_doc_id: interimDocId,
                        sf_course_code: sfTrainerCode, // This is SFCode-TP
                        labbuild_course: lbCourse,
                        vendor: vendor,
                        memory_gb_one_pod: memOnePod,
                        build_trainer: buildCheckbox.checked, // Key field!
                        interactive_assignments: [],
                        error_message: null
                    };

                    if (buildCheckbox.disabled) { // Disabled by rule from backend
                        trainerAssignmentPayload.build_trainer = false; // Ensure it's false
                        trainerAssignmentPayload.error_message = trainerRow.querySelector('.error-icon-container')?.title || "Disabled by rule";
                    } else if (buildCheckbox.checked) { // User wants to build this trainer pod
                        const hostSelect = trainerRow.querySelector('.sub-host-select');
                        const startPodInput = trainerRow.querySelector('.start-pod-input');
                        calculateAndDisplayTrainerPodMemory(trainerRow); // Re-run validation
                        
                        if (!hostSelect.value || hostSelect.value === "") {
                            alert(`Host not selected for Trainer Pod: ${sfTrainerCode}. Uncheck "Build Trainer?" or select a host.`);
                            hostSelect.focus(); isTrainerFormCompletelyValid = false; return;
                        }
                        if (startPodInput.classList.contains('is-invalid')) {
                            alert(`Invalid pod for Trainer Pod: ${sfTrainerCode}. Uncheck "Build Trainer?" or correct pod number.`);
                            startPodInput.focus(); isTrainerFormCompletelyValid = false; return;
                        }
                        const podValue = parseInt(startPodInput.value, 10);
                        trainerAssignmentPayload.interactive_assignments = [{ host: hostSelect.value, start_pod: podValue, end_pod: podValue }];
                        trainerAssignmentPayload.error_message = trainerRow.querySelector('.error-icon-container') ? trainerRow.querySelector('.error-icon-container').title : null;
                    } else { // User unchecked "Build Trainer?"
                        trainerAssignmentPayload.error_message = "User opted out of building this trainer pod.";
                        // interactive_assignments remains empty
                    }
                    finalTrainerAssignments.push(trainerAssignmentPayload);
                });

                if (!isTrainerFormCompletelyValid) {
                    event.preventDefault(); return;
                }
                
                const finalTrainerAssignmentsInput = document.getElementById('finalTrainerAssignmentsInput');
                if (finalTrainerAssignmentsInput) {
                    finalTrainerAssignmentsInput.value = JSON.stringify(finalTrainerAssignments);
                } else {
                    console.error("Hidden input #finalTrainerAssignmentsInput not found."); event.preventDefault(); return;
                }
            });
        }
    });
    </script>
{% endblock %}