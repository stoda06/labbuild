{# dashboard/templates/trainer_pod_review.html #}
{% extends 'base.html' %}

{% block title %}Review Trainer Pod Allocation{% endblock %}

{% block head %}
    {{ super() }}
    {# The existing CSS file is correct and does not need changes #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/trainer_pod_review.css') }}">
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
   <h1>Review Trainer Pod Allocation (Batch ID: {{ batch_review_id }})</h1>
   <a href="javascript:history.back()" 
      onclick="return confirm('Are you sure? Changes on this page will be lost, returning to student assignments.');" 
      class="btn btn-sm btn-outline-secondary">
      Back to Student Assignments
    </a>
</div>

<div class="card">
    <div class="card-header">Step 2: Assign or Skip Trainer Pods</div>
    <div class="card-body">
        {% if courses_and_trainer_pods %}
            <p>For each course, decide if a trainer pod should be built. Adjust host/pod if necessary.</p>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered review-table" id="trainerReviewTable">
                    <thead class="table-light">
                        <tr>
                            <th class="col-sf-code">SF Course Code</th>
                            <th class="col-lb-course">LabBuild Course</th>
                            <th class="col-vendor">Vendor</th>
                            <th class="col-trainer-build-toggle">Build Trainer?</th>
                            <th class="col-interactive-assignments-trainer">Trainer Pod Assignment</th>
                            <th class="col-total-interactive-memory">Est. Mem (GB)</th> 
                        </tr>
                    </thead>
                    <tbody>
                        {# --- MODIFICATION START: Corrected loop and data access --- #}
                        {# The loop now iterates over each combined 'item' #}
                        {% for item in courses_and_trainer_pods %}
                            {% set student_part = item.student_part %}
                            {% set trainer_part = item.trainer_part %}
                            <tr class="trainer-data-row" 
                                data-interim-doc-id="{{ trainer_part.interim_doc_id }}"
                                data-labbuild-course="{{ trainer_part.labbuild_course or '' }}" 
                                data-memory-one-pod="{{ trainer_part.memory_gb_one_pod | default(0.0) }}"
                                data-sf-course-code-trainer="{{ trainer_part.sf_course_code }}"
                                data-vendor="{{ trainer_part.vendor | lower if trainer_part.vendor else '' }}">

                                <td class="col-sf-code" title="{{ student_part.sf_course_code }}">
                                    <strong>{{ student_part.sf_course_code }}</strong>
                                    <small class="d-block text-muted">{{ student_part.sf_trainer_name }}</small>
                                </td>
                                <td class="col-lb-course" title="{{ trainer_part.labbuild_course or 'N/A' }}">{{ trainer_part.labbuild_course or 'N/A' }}</td>
                                <td class="col-vendor">{{ student_part.vendor | upper if student_part.vendor else 'N/A'}}</td>
                                
                                <td class="col-trainer-build-toggle">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input build-trainer-checkbox" type="checkbox" 
                                               value="yes" id="build_trainer_{{ loop.index0 }}"
                                               {% if not trainer_part.error_message or "capacity" in (trainer_part.error_message or "") %}
                                                   checked 
                                               {% endif %}
                                               {% if trainer_part.error_message and "Disabled by Rule" in trainer_part.error_message %}
                                                   disabled title="{{trainer_part.error_message}}"
                                               {% endif %}>
                                    </div>
                                </td>

                                <td class="col-interactive-assignments-trainer interactive-assignments-cell">
                                    <div class="assignment-sub-row {% if trainer_part.error_message and 'Disabled by Rule' in trainer_part.error_message %}disabled-inputs{% endif %}">
                                        <select name="host_assignment_tp_{{ loop.index0 }}" 
                                                class="form-select form-select-sm sub-host-select">
                                            <option value="">-- Host --</option>
                                            {% for host_name_opt_tp in all_hosts %}
                                            <option value="{{ host_name_opt_tp }}" {% if trainer_part.assigned_host == host_name_opt_tp %}selected{% endif %}>
                                                {{ host_name_opt_tp }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <input type="number" name="start_pod_tp_{{ loop.index0 }}" 
                                               class="form-control form-control-sm sub-pod-input start-pod-input" 
                                               value="{{ trainer_part.start_pod | default(1) }}" min="1" placeholder="Pod #">
                                        <input type="number" name="end_pod_tp_{{ loop.index0 }}" 
                                               class="form-control form-control-sm sub-pod-input end-pod-input" 
                                               value="{{ trainer_part.start_pod | default(1) }}" min="1" readonly 
                                               title="End pod is same as start for a single trainer pod">
                                        {% if trainer_part.error_message and "Disabled by Rule" not in trainer_part.error_message %}
                                            <span class="error-icon-container" title="{{trainer_part.error_message}}">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </span>
                                        {% endif %}
                                    </div>
                                     {% if trainer_part.error_message and "Disabled by Rule" in trainer_part.error_message %}
                                        <small class="text-muted fst-italic">{{trainer_part.error_message}}</small>
                                    {% endif %}
                                </td>
                                <td class="col-total-interactive-memory text-end">
                                    <span class="total-course-memory-display">
                                        {% if trainer_part.error_message and "Disabled by Rule" in trainer_part.error_message %}N/A{% else %}0.00{% endif %}
                                    </span> GB
                                </td> 
                            </tr>
                        {% endfor %}
                        {# --- MODIFICATION END --- #}
                    </tbody>
                </table>
            </div>

            <div class="mt-4">
                <form action="{{ url_for('actions.finalize_and_display_build_plan') }}" method="POST" id="finalizeAndProceedForm">
                     <input type="hidden" name="batch_review_id" value="{{ batch_review_id }}">
                     <input type="hidden" name="final_trainer_assignments_for_review" id="finalTrainerAssignmentsInput">
                     
                     <button type="submit" class="btn btn-lg btn-primary">
                         <i class="fas fa-check-double"></i> Finalize & View Full Plan
                     </button>
                     <a href="{{ url_for('main.view_upcoming_courses') }}" 
                        onclick="return confirm('Are you sure? All progress in this batch review will be lost.');"
                        class="btn btn-lg btn-secondary ms-2">
                        Cancel Batch
                    </a>
                </form>
            </div>
        {% else %}
            <div class="alert alert-warning"> No course data available for trainer pod allocation. Batch ID: {{ batch_review_id or "Unknown" }}</div>
             <a href="{{ url_for('main.view_upcoming_courses') }}" class="btn btn-secondary">Back to Upcoming Courses</a>
        {% endif %}
    </div> 
</div> 

{# Embedded data for JavaScript #}
<script id="courseMemoryDataTrainer" type="application/json">
    {{ course_configs_for_memory | tojson | safe }}
</script>
<script id="memoryFactorDataTrainer" type="application/json">
    {{ {"factor": subsequent_pod_memory_factor} | tojson | safe }}
</script>

{% endblock %}

{% block scripts %}
    {{ super() }}
    {# The existing JS file is correct and does not need changes #}
    <script src="{{ url_for('static', filename='js/trainer_pod_review.js') }}" defer></script>
{% endblock %}