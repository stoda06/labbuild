{# dashboard/templates/allocations.html #}
{% extends 'base.html' %}

{# Sets the title of the browser tab or window #}
{% block title %}Current Allocations{% endblock %}

{% block content %}
{# Inline styles specific to this page for table layout and appearance #}
<style>
    /* Base styling for table cells */
    .allocation-table th, .allocation-table td {
        font-size: 0.9rem;      /* Slightly smaller font */
        vertical-align: middle; /* Center content vertically */
        padding-top: 0.4rem;    /* Reduce vertical padding */
        padding-bottom: 0.4rem;
    }
    /* Ensure action forms display inline and have slight spacing */
    .action-forms form {
        margin-bottom: 0;
        display: inline-block;
        margin-left: 2px;
        margin-right: 2px;
    }
    /* Style for delete/action buttons (icons) */
    .action-btn { /* More generic class */
        background: none;
        border: none;
        padding: 0.1rem 0.4rem;
        line-height: 1;
        font-size: 1rem;
        opacity: 0.65;
        transition: opacity 0.2s ease, color 0.2s ease;
        vertical-align: middle;
        cursor: pointer;
    }
    .action-btn:hover {
        opacity: 1;
    }
    .action-btn.text-danger { color: var(--bs-danger); }
    .action-btn.text-danger:hover { color: var(--bs-danger); } /* Keep color on hover */
    .action-btn.text-warning { color: var(--bs-warning); }
    .action-btn.text-warning:hover { color: var(--bs-warning); }
    .action-btn.text-secondary { color: #6c757d; } /* Neutral grey */
    .action-btn.text-secondary:hover { color: #5a6268; }

    /* Dark mode overrides for action buttons */
    html.dark-mode .action-btn.text-danger { color: #ff8a80; }
    html.dark-mode .action-btn.text-danger:hover { color: #ff5252; }
    html.dark-mode .action-btn.text-warning { color: #ffd76d; }
    html.dark-mode .action-btn.text-warning:hover { color: #ffc94a; }
    html.dark-mode .action-btn.text-secondary { color: #adb5bd; }
    html.dark-mode .action-btn.text-secondary:hover { color: #ced4da; }


    /* Style for PRTG link button */
    .prtg-link {
        vertical-align: middle;
        padding: 0 0.25rem !important;
    }

    /* Styles for Header Rows - Grouping Visualization */
    .header-row td {
        font-weight: bold;
        background-color: #f1f3f5; /* Light Grey base for headers (Light Mode) */
        padding-top: 0.6rem;
        padding-bottom: 0.6rem;
        border-bottom: 1px solid #dee2e6;
        border-top: 1px solid #dee2e6;
    }
    /* TAG Header - Most prominent */
    .tag-header td {
        font-size: 1.05em;
        color: #212529;     /* Dark standard text */
    }
    /* COURSE Header - Indented, slightly less prominent */
    .course-header td {
        padding-left: 25px !important;
        font-style: normal;
        font-weight: 600;   /* Semi-bold */
        color: #495057;     /* Darker Grey */
        background-color: #f8f9fa; /* Very light grey, almost white */
    }
    /* HOST Header - Most indented, muted */
    .host-header td {
        padding-left: 50px !important;
        font-weight: 600;
        color: #6c757d;     /* Muted Grey */
        background-color: #ffffff; /* White background */
    }

    /* Dark Mode Header Overrides - Using subtle greys */
    html.dark-mode .header-row td {
         background-color: #2c3034; /* Darker base for headers */
         border-color: #454b50;
    }
    html.dark-mode .tag-header td {
         color: #e9ecef; /* Light text */
    }
    html.dark-mode .course-header td {
         color: #ced4da; /* Lighter grey */
         background-color: #262a2e; /* Slightly lighter than base header */
    }
    html.dark-mode .host-header td {
         color: #adb5bd; /* Muted light grey */
         background-color: #212529; /* Match main dark background */
    }

    /* Data Rows */
    .data-row td:first-child {
        padding-left: 75px !important; /* Indent data under host */
    }
    .data-row td {
        font-size: 0.85rem; /* Slightly smaller data font */
    }
    /* Ensure data rows get correct dark mode background */
    html.dark-mode .data-row td {
         background-color: inherit; /* Should inherit from body/card */
    }
    /* Container for pagination controls */
    .pagination-controls {
        margin-top: 1rem; /* Space above controls */
    }
     /* Power Toggle Button Specifics */
    .power-toggle-btn {
        font-size: 1.1rem; /* Slightly larger icon */
    }
    .power-toggle-btn.text-danger { color: var(--bs-danger); } /* Red when ON */
    .power-toggle-btn.text-secondary { color: #6c757d; } /* Grey when OFF */
    html.dark-mode .power-toggle-btn.text-danger { color: #ff8a80; } /* Lighter red */
    html.dark-mode .power-toggle-btn.text-secondary { color: #adb5bd; } /* Lighter grey */

</style>

{# --- Page Header --- #}
<div class="d-flex justify-content-between align-items-center mb-3">
   <h1>Current Allocations</h1>
   <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
</div>

{# --- Filter Form --- #}
<div class="card mb-4">
    <div class="card-header">Filter Allocations</div>
    <div class="card-body">
        <form action="{{ url_for('main.view_allocations') }}" method="GET" class="row g-3">
             <div class="col-md-3"><label for="filter_tag" class="form-label">Tag (contains)</label><input type="text" class="form-control form-control-sm" id="filter_tag" name="filter_tag" value="{{ current_filters.get('filter_tag', '') }}"></div>
             <div class="col-md-2"><label for="filter_vendor" class="form-label">Vendor (exact)</label><input type="text" class="form-control form-control-sm" id="filter_vendor" name="filter_vendor" value="{{ current_filters.get('filter_vendor', '') }}"></div>
             <div class="col-md-3"><label for="filter_course" class="form-label">Course (contains)</label><input type="text" class="form-control form-control-sm" id="filter_course" name="filter_course" value="{{ current_filters.get('filter_course', '') }}"></div>
             <div class="col-md-2"><label for="filter_host" class="form-label">Host (contains)</label><input type="text" class="form-control form-control-sm" id="filter_host" name="filter_host" value="{{ current_filters.get('filter_host', '') }}"></div>
             <div class="col-md-2"><label for="filter_number" class="form-label">Pod/Class # (exact)</label><input type="number" class="form-control form-control-sm" id="filter_number" name="filter_number" value="{{ current_filters.get('filter_number', '') }}"></div>
             <div class="col-12"><button type="submit" class="btn btn-primary btn-sm">Filter</button> <a href="{{ url_for('main.view_allocations') }}" class="btn btn-secondary btn-sm">Clear Filters</a></div>
        </form>
    </div>
</div>

{# --- Allocation Table Card --- #}
<div class="card">
  {# Display total count of actual data items found after filtering #}
  <div class="card-header">Allocation List ({{ total_data_items }} total pods/classes matching filters)</div>
  <div class="card-body p-0"> {# Remove padding for table to touch edges #}
    {# Check if allocation_list (the paginated slice) has items #}
    {% if allocation_list %}
      <div class="table-responsive">
        {# Use a standard table ID #}
        <table class="table table-sm table-hover mb-0 allocation-table" id="allocations-table">
          <thead class="table-light">
            {# Define table headers #}
            <tr>
              <th>Scope / Item</th>
              <th>Type</th>
              <th>Number</th>
              <th>Nested Pods (F5)</th>
              <th>PRTG</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {# Loop through the paginated list passed from Flask #}
            {% for item in allocation_list %}
              {# Conditional rendering based on row_type #}
              {% if item.row_type == 'tag_header' %}
                {# Render a Tag Header Row #}
                <tr class="header-row tag-header" data-row-type="tag_header">
                  {# Span most columns, leave space for actions #}
                  <td colspan="5"><strong>Tag:</strong> {{ item.tag }}</td>
                  {# Actions for Tag Row #}
                  <td class="text-end action-forms">
                      {# Power Toggle for ENTIRE Tag #}
                       <form action="{{ url_for('actions.toggle_power') }}" method="POST" class="d-inline" onsubmit="return confirm('Toggle power (Start/Stop) for ALL items in Tag \'{{ item.tag }}\'?')">
                           <input type="hidden" name="scope" value="tag">
                           <input type="hidden" name="tag" value="{{ item.tag }}">
                           {# Indicate a 'toggle' action - backend determines start/stop per group #}
                           <input type="hidden" name="current_state" value="toggle">
                            {# Pass filters back #}
                           {% for key, value in current_filters.items() %}<input type="hidden" name="filter_{{ key.replace('filter_', '') }}" value="{{ value }}">{% endfor %}
                           <button type="submit" class="action-btn power-toggle-btn text-secondary" title="Toggle Power for ALL items in Tag '{{ item.tag }}'">
                               <i class="fas fa-power-off"></i>
                           </button>
                       </form>

                      {# Teardown ENTIRE Tag (Infrastructure) - Use Dumpster Icon #}
                      <form action="{{ url_for('actions.teardown_tag') }}" method="POST" class="d-inline" onsubmit="return confirm('TEARDOWN ALL resources (VMs, networks, etc.) for Tag \'{{ item.tag }}\'? This affects ALL courses/hosts under this tag and CANNOT be easily undone.')">
                          <input type="hidden" name="tag" value="{{ item.tag }}">
                           {# Pass filters back #}
                           {% for key, value in current_filters.items() %}<input type="hidden" name="filter_{{ key.replace('filter_', '') }}" value="{{ value }}">{% endfor %}
                          <button type="submit" class="action-btn delete-btn text-danger" title="Teardown ALL Resources for Tag '{{ item.tag }}'">
                              <i class="fas fa-dumpster"></i> {# Dumpster Icon #}
                          </button>
                      </form>

                      {# Delete Tag DB Entry Only #}
                      <form action="{{ url_for('actions.teardown_item') }}" method="POST" class="d-inline" onsubmit="return confirm('DELETE DB entry for ENTIRE Tag \'{{ item.tag }}\'? This affects all courses and pods under this tag. This CANNOT be undone.')">
                          <input type="hidden" name="delete_level" value="tag_db">
                          <input type="hidden" name="tag" value="{{ item.tag }}">
                           {# Pass filters back #}
                           {% for key, value in current_filters.items() %}<input type="hidden" name="filter_{{ key.replace('filter_', '') }}" value="{{ value }}">{% endfor %}
                          <button type="submit" class="action-btn delete-btn text-warning" title="Delete ENTIRE Tag '{{ item.tag }}' DB Entry Only">
                              <i class="fas fa-database"></i><i class="fas fa-times"></i>
                          </button>
                      </form>
                  </td>
                </tr>
              {% elif item.row_type == 'course_header' %}
                {# Render a Course Header Row - No actions typically needed here #}
                <tr class="header-row course-header" data-row-type="course_header">
                  <td colspan="6"><strong>Course:</strong> {{ item.course_name }}</td>
                </tr>
              {% elif item.row_type == 'host_header' %}
                 {# Render a Host Header Row - No actions typically needed here #}
                 <tr class="header-row host-header" data-row-type="host_header">
                  <td colspan="6"><strong>Host:</strong> {{ item.host }}</td>
                </tr>
              {% elif item.row_type == 'data' %}
                {# Render an actual Data Row #}
                <tr class="data-row" data-row-type="data">
                  <td></td> {# Empty first cell for indentation via CSS #}
                  {# Type Column #}
                  <td>
                      {% if item.type == 'f5_class' %}
                          <span class="badge bg-info text-dark">F5 Class</span>
                      {% elif item.type == 'pod' %}
                          <span class="badge bg-secondary">Pod</span>
                      {% else %}
                          {{ item.type | capitalize }}
                      {% endif %}
                  </td>
                  {# Number Column #}
                  <td>{{ item.number }}</td>
                  {# Nested Pods Column #}
                  <td>
                      {% if item.type == 'f5_class' and item.nested_pods %}
                          {{ item.nested_pods | join(', ') }}
                      {% else %}
                          -
                      {% endif %}
                  </td>
                  {# PRTG Column #}
                  <td>
                      {% if item.prtg_url %}
                          <a href="{{ item.prtg_url }}" target="_blank" class="btn btn-outline-info btn-sm p-0 px-1 me-1 prtg-link" title="View PRTG for Item {{ item.number }}"><i class="fas fa-chart-line fa-xs"></i></a>
                      {% else %}
                          <span class="text-muted">N/A</span>
                      {% endif %}
                  </td>
                  {# Actions Column #}
                  <td class="text-end action-forms">
                        {# Power Toggle for Individual Item #}
                        <form action="{{ url_for('actions.toggle_power') }}" method="POST"
                                class="d-inline power-toggle-form"
                                {# Add data attributes for confirmation message parts #}
                                data-action="{{ 'Stop' if item.poweron else 'Start' }}"
                                data-item-type="{{ item.type }}"
                                data-item-number="{{ item.number }}"
                                >
                            <input type="hidden" name="scope" value="item">
                            <input type="hidden" name="tag" value="{{ item.tag }}">
                            <input type="hidden" name="item_type" value="{{ item.type }}">
                            <input type="hidden" name="item_number" value="{{ item.number }}">
                            <input type="hidden" name="host" value="{{ item.host }}">
                            <input type="hidden" name="vendor" value="{{ item.vendor }}">
                            <input type="hidden" name="course" value="{{ item.course_name }}">
                            <input type="hidden" name="current_state" value="{{ 'on' if item.poweron else 'off' }}">
                            {# Pass class context if it's an F5 pod #}
                            {% if item.type == 'pod' and item.vendor.lower() == 'f5' and item.class_number %}
                                <input type="hidden" name="item_class_number" value="{{ item.class_number }}">
                            {% endif %}
                             {# Pass filters back #}
                            {% for key, value in current_filters.items() %}<input type="hidden" name="filter_{{ key.replace('filter_', '') }}" value="{{ value }}">{% endfor %}
                            {# Set icon color based on item.poweron #}
                            <button type="submit" class="action-btn power-toggle-btn {{ 'text-danger' if item.poweron else 'text-secondary' }}" title="{{ 'Stop' if item.poweron else 'Start' }} Item {{ item.number }}">
                                <i class="fas fa-power-off"></i>
                            </button>
                        </form>

                        {# Teardown Item Form #}
                         <form action="{{ url_for('actions.teardown_item') }}" method="POST" class="d-inline" onsubmit="return confirm('Teardown {{ item.type }} {{ item.number }}? This deletes VMs.')">
                           <input type="hidden" name="delete_level" value="{{ 'class' if item.type == 'f5_class' else 'pod' }}">
                           {# Pass context #}
                           <input type="hidden" name="tag" value="{{ item.tag }}">
                           <input type="hidden" name="host" value="{{ item.host }}">
                           <input type="hidden" name="vendor" value="{{ item.vendor }}">
                           <input type="hidden" name="course" value="{{ item.course_name }}">
                           {% if item.type == 'pod' %} <input type="hidden" name="pod_number" value="{{ item.number }}"> {% endif %}
                           {% if item.type == 'f5_class' %} <input type="hidden" name="class_number" value="{{ item.number }}"> {% endif %}
                           {% if item.type == 'pod' and item.vendor.lower() == 'f5' and item.class_number %}<input type="hidden" name="class_number" value="{{ item.class_number }}">{% endif %}
                           {# Pass filters back #}
                           {% for key, value in current_filters.items() %}<input type="hidden" name="filter_{{ key.replace('filter_', '') }}" value="{{ value }}">{% endfor %}
                           <button type="submit" class="action-btn delete-btn text-danger" title="Teardown {{ item.type }} {{ item.number }}">
                               <i class="fas fa-trash-alt"></i>
                           </button>
                         </form>

                        {# DB Delete Item Form #}
                         <form action="{{ url_for('actions.teardown_item') }}" method="POST" class="d-inline" onsubmit="return confirm('DELETE DB entry ONLY for {{ item.type }} {{ item.number }}?')">
                           <input type="hidden" name="delete_level" value="{{ 'class_db' if item.type == 'f5_class' else 'pod_db' }}">
                           {# Pass context #}
                           <input type="hidden" name="tag" value="{{ item.tag }}">
                           <input type="hidden" name="course" value="{{ item.course_name }}">
                           {% if item.type == 'pod' %} <input type="hidden" name="pod_number" value="{{ item.number }}"> {% endif %}
                           {% if item.type == 'f5_class' %} <input type="hidden" name="class_number" value="{{ item.number }}"> {% endif %}
                           {% if item.type == 'pod' and item.vendor.lower() == 'f5' and item.class_number %}<input type="hidden" name="class_number" value="{{ item.class_number }}">{% endif %}
                            {# Pass filters back #}
                           {% for key, value in current_filters.items() %}<input type="hidden" name="filter_{{ key.replace('filter_', '') }}" value="{{ value }}">{% endfor %}
                           <button type="submit" class="action-btn delete-btn text-warning" title="Delete DB Entry Only for {{ item.type }} {{ item.number }}">
                               <i class="fas fa-database"></i><i class="fas fa-times fa-xs"></i>
                           </button>
                         </form>
                  </td>
                </tr>
              {% endif %} {# End conditional rendering for item.row_type #}
            {% endfor %} {# End Item Loop #}
          </tbody>
        </table>
      </div> {# End table-responsive #}

      {# --- Server-Side Pagination Controls --- #}
      {% if total_pages > 1 %}
        <nav aria-label="Allocation pagination" class="p-3 pagination-controls">
          <ul class="pagination pagination-sm justify-content-center mb-0">
            {# Previous Page Link #}
            <li class="page-item {{ 'disabled' if current_page == 1 else '' }}">
              <a class="page-link" href="{{ url_for('main.view_allocations', page=current_page-1, **pagination_args) }}">Previous</a>
            </li>
            {# Page Number Links (Example with ellipsis) #}
            {% set page_window = 2 %}
            {% for page_num in range(1, total_pages + 1) %}
                {% if page_num == 1 or page_num == total_pages or (page_num >= current_page - page_window and page_num <= current_page + page_window) %}
                     <li class="page-item {{ 'active' if page_num == current_page else '' }}">
                         <a class="page-link" href="{{ url_for('main.view_allocations', page=page_num, **pagination_args) }}">{{ page_num }}</a>
                     </li>
                {% elif page_num == 2 and current_page > page_window + 2 %}
                     <li class="page-item disabled"><span class="page-link">...</span></li>
                {% elif page_num == total_pages - 1 and current_page < total_pages - page_window - 1 %}
                     <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            {# Next Page Link #}
            <li class="page-item {{ 'disabled' if current_page == total_pages else '' }}">
              <a class="page-link" href="{{ url_for('main.view_allocations', page=current_page+1, **pagination_args) }}">Next</a>
            </li>
          </ul>
        </nav>
      {% endif %}
      {# --- End Pagination Controls --- #}

    {% else %} {# If allocation_list (paginated slice) is empty #}
      <p class="p-3">No allocations found matching filters{% if current_page > 1 %} for this page{% endif %}.</p>
    {% endif %}
  </div> {# End card-body #}
</div> {# End card #}

{% endblock %}

{% block scripts %}
  {{ super() }} {# Include base scripts (dark mode, timezone) #}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('allocations-tbody');

        if (tableBody) {
            tableBody.addEventListener('submit', function(event) {
                // Check if the submitted form is one of our power toggle forms
                if (event.target && event.target.classList.contains('power-toggle-form')) {
                    const form = event.target;
                    // Retrieve data from attributes
                    const action = form.dataset.action || 'Toggle'; // Fallback text
                    const itemType = form.dataset.itemType || 'item';
                    const itemNumber = form.dataset.itemNumber || '?';

                    // Construct the confirmation message
                    const message = `Are you sure you want to ${action} ${itemType} ${itemNumber}?`;

                    // Show confirmation dialog
                    if (!confirm(message)) {
                        event.preventDefault(); // Prevent form submission if user cancels
                    }
                    // If user confirms, the form submits normally
                }
                // You can add similar logic for other forms if their confirm messages become complex
            });
        } else {
            console.warn("Could not find table body 'allocations-tbody' to attach submit listener.");
        }
    });
  </script>
{% endblock %}