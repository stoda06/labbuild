{# dashboard/templates/settings_course_configs.html #}
{% extends 'base.html' %}

{% block title %}Course Configurations{% endblock %}

{# Link to the new CSS file #}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings_course_configs.css') }}">
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
   <h1>Course Configurations</h1>
   <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
</div>

{# --- Filter Form (Unchanged) --- #}
<div class="card mb-4">
    <div class="card-header">Filter Configurations</div>
    <div class="card-body">
      <form action="{{ url_for('settings.view_course_configs') }}" method="GET" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="filter_vendor" class="form-label">Vendor</label>
          <input type="text" class="form-control form-control-sm" id="filter_vendor" name="filter_vendor" value="{{ current_params.get('filter_vendor', '') }}">
        </div>
        <div class="col-md-4">
          <label for="filter_course_name" class="form-label">Course Name (contains)</label>
          <input type="text" class="form-control form-control-sm" id="filter_course_name" name="filter_course_name" value="{{ current_params.get('filter_course_name', '') }}">
        </div>
        <div class="col-md-2">
            <label for="per_page" class="form-label">Per Page</label>
            <select class="form-select form-select-sm" id="per_page" name="per_page" onchange="this.form.submit()">
                {% for option in per_page_options %}
                <option value="{{ option }}" {% if option == current_params.per_page|int %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary btn-sm w-100">Filter</button>
          <a href="{{ url_for('settings.view_course_configs') }}" class="btn btn-secondary btn-sm w-100 mt-1">Clear Filters</a>
        </div>
      </form>
    </div>
</div>

<div class="mb-3">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#configModal" data-mode="add">
        <i class="fas fa-plus"></i> Add New Course Configuration
    </button>
</div>

<div class="card">
    <div class="card-header">Existing Course Configurations</div>
    <div class="card-body p-0">
        {% if configs %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover mb-0 configs-table">
                    <thead class="table-light">
                        <tr>
                            <th>Vendor</th>
                            <th>Course Name</th>
                            <th>Configuration Preview</th> {# Renamed for clarity #}
                            <th class="text-end">Manage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for config_doc in configs %}
                        <tr data-config-id="{{ config_doc._id }}">
                            <td>{{ config_doc.vendor_shortcode | upper }}</td>
                            <td>{{ config_doc.course_name }}</td>
                            <td>
                                {# --- THIS IS THE MODIFIED SECTION --- #}
                                {# Instead of a pre-tag, include a formatted preview partial #}
                                {% include 'partials/_config_preview.html' %}
                                {# --- END OF MODIFICATION --- #}
                            </td>
                            <td class="text-end btn-action-group">
                                <button type="button" class="btn btn-sm btn-warning edit-config-btn"
                                        data-bs-toggle="modal" data-bs-target="#configModal"
                                        data-mode="edit"
                                        data-config-id="{{ config_doc._id }}"
                                        data-config-json='{{ config_doc | tojson }}'
                                        title="Edit Configuration">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form action="{{ url_for('settings.delete_course_config', config_id=config_doc._id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete config \'{{ config_doc.course_name }}\'?')">
                                    <button type="submit" class="btn btn-sm btn-danger" title="Delete Configuration"><i class="fas fa-trash-alt"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if total_pages > 1 %}
            <nav aria-label="Course Configs pagination" class="p-3">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item {{ 'disabled' if current_page == 1 else '' }}">
                        <a class="page-link" href="{{ url_for('settings.view_course_configs', page=current_page-1, **current_params) }}">Previous</a>
                    </li>
                    {% set page_window = 2 %}
                    {% for page_num in range(1, total_pages + 1) %}
                        {% if page_num == 1 or page_num == total_pages or
                              (page_num >= current_page - page_window and page_num <= current_page + page_window) %}
                            <li class="page-item {{ 'active' if page_num == current_page else '' }}">
                                <a class="page-link" href="{{ url_for('settings.view_course_configs', page=page_num, **current_params) }}">{{ page_num }}</a>
                            </li>
                        {% elif page_num == 2 and current_page > page_window + 2 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% elif page_num == total_pages - 1 and current_page < total_pages - page_window - 1 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    <li class="page-item {{ 'disabled' if current_page == total_pages else '' }}">
                        <a class="page-link" href="{{ url_for('settings.view_course_configs', page=current_page+1, **current_params) }}">Next</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        {% else %}
        <p class="p-3 text-muted">
          No course configurations found
          {% if current_params.filter_vendor or current_params.filter_course_name %}
              matching your filter criteria. <a href="{{ url_for('settings.view_course_configs') }}">Clear filters</a> to see all.
          {% else %}
              in the database.
          {% endif %}
      </p>
        {% endif %}
    </div>
</div>

{# --- UNIFIED Add/Edit Modal with Dynamic Form --- #}
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
    <div class="modal-content">
      <form id="configForm" method="POST">
        <input type="hidden" id="config_id" name="config_id">
        <div class="modal-header">
          <h5 class="modal-title" id="configModalLabel">Course Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            {# --- Top Level Simple Fields --- #}
            <div class="row g-3 mb-3">
                <div class="col-md-6"><label for="course_name" class="form-label">Course Name <span class="text-danger">*</span></label><input type="text" class="form-control form-control-sm" id="course_name" name="course_name" required></div>
                <div class="col-md-3"><label for="vendor_shortcode" class="form-label">Vendor <span class="text-danger">*</span></label><input type="text" class="form-control form-control-sm" id="vendor_shortcode" name="vendor_shortcode" required></div>
                <div class="col-md-3"><label for="alias" class="form-label">Alias</label><input type="text" class="form-control form-control-sm" id="alias" name="alias"></div>
                <div class="col-md-6"><label for="apm_version" class="form-label">APM Version</label><input type="text" class="form-control form-control-sm" id="apm_version" name="apm_version"></div>
                <div class="col-md-6"><label for="memory" class="form-label">Memory (Int)</label><input type="number" class="form-control form-control-sm" id="memory" name="memory" min="0"></div>
            </div>

            {# --- Accordion for Complex Array/Object Fields --- #}
            <div class="accordion" id="configAccordion">
                
                <!-- Components Section -->
                {% with section_name='components', title='Components', singular_title='Component' %}
                    {% include 'partials/_config_form_section.html' %}
                {% endwith %}
                
                <!-- Networks Section (with nested Port Groups) -->
                {% with section_name='networks', title='Networks', singular_title='Network' %}
                    {% include 'partials/_config_form_section.html' %}
                {% endwith %}

                <!-- Groups Section -->
                 {% with section_name='groups', title='Groups', singular_title='Group' %}
                    {% include 'partials/_config_form_section.html' %}
                {% endwith %}

                <!-- PRTG Section -->
                 {% with section_name='prtg', title='PRTG', singular_title='PRTG Entry' %}
                    {% include 'partials/_config_form_section.html' %}
                {% endwith %}

                 <!-- Servers Section -->
                 {% with section_name='servers', title='Servers', singular_title='Server' %}
                    {% include 'partials/_config_form_section.html' %}
                {% endwith %}

            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# --- HIDDEN TEMPLATES for Dynamic Form Sections --- #}

<!-- Template for one "Component" item -->
<template id="components-template">
    <div class="dynamic-item card card-body mb-2">
        <div class="row g-2">
            <div class="col-md-4"><label class="form-label">Component Name</label><input type="text" class="form-control form-control-sm" name="components[__INDEX__][component_name]"></div>
            <div class="col-md-4"><label class="form-label">Clone Name</label><input type="text" class="form-control form-control-sm" name="components[__INDEX__][clone_name]"></div>
            <div class="col-md-4"><label class="form-label">Base VM</label><input type="text" class="form-control form-control-sm" name="components[__INDEX__][base_vm]"></div>
            <div class="col-md-4"><label class="form-label">Snapshot</label><input type="text" class="form-control form-control-sm" name="components[__INDEX__][snapshot]"></div>
            <div class="col-md-4"><label class="form-label">State</label><input type="text" class="form-control form-control-sm" name="components[__INDEX__][state]"></div>
            <div class="col-md-4"><label class="form-label">UUID</label><input type="text" class="form-control form-control-sm" name="components[__INDEX__][uuid]"></div>
        </div>
        <button type="button" class="btn-close remove-item-btn" aria-label="Remove"></button>
    </div>
</template>

<!-- Template for one "Network" item (includes nested Port Groups) -->
<template id="networks-template">
    <div class="dynamic-item card card-body mb-2">
         <div class="row g-2">
            <div class="col-md-4"><label class="form-label">Switch Name</label><input type="text" class="form-control form-control-sm" name="networks[__INDEX__][switch_name]"></div>
            <div class="col-md-4"><label class="form-label">Switch (Legacy)</label><input type="text" class="form-control form-control-sm" name="networks[__INDEX__][switch]"></div>
            <div class="col-md-4"><label class="form-label">Promiscuous Mode (CSV)</label><input type="text" class="form-control form-control-sm" name="networks[__INDEX__][promiscuous_mode]"></div>
        </div>
        <hr>
        <h6>Port Groups</h6>
        <div class="nested-items-container ps-3" data-parent-name="networks" data-parent-index="__INDEX__" data-section-name="port_groups">
            <!-- Port Group items will be injected here -->
        </div>
        <button type="button" class="btn btn-sm btn-outline-info mt-2 add-nested-item-btn" data-template-id="port_groups-template">Add Port Group</button>
        <button type="button" class="btn-close remove-item-btn" aria-label="Remove"></button>
    </div>
</template>

<!-- Template for one "Port Group" item (to be nested in Networks) -->
<template id="port_groups-template">
    <div class="dynamic-item-nested card card-body mb-2">
        <div class="row g-2">
            <div class="col-md-6"><label class="form-label">Port Group Name</label><input type="text" class="form-control form-control-sm" name="__PARENT_NAME__[__PARENT_INDEX__][port_groups][__INDEX__][port_group_name]"></div>
            <div class="col-md-4"><label class="form-label">VLAN ID</label><input type="text" class="form-control form-control-sm" name="__PARENT_NAME__[__PARENT_INDEX__][port_groups][__INDEX__][vlan_id]"></div>
        </div>
        <button type="button" class="btn-close remove-item-btn" aria-label="Remove"></button>
    </div>
</template>

<!-- A generic template for other simple object arrays (groups, prtg, servers) -->
<template id="generic-object-template">
     <div class="dynamic-item card card-body mb-2">
        <div class="row g-2">
            <!-- Generic key-value pairs -->
            <div class="col-md-5"><label class="form-label">Key</label><input type="text" class="form-control form-control-sm generic-key-input" value=""></div>
            <div class="col-md-5"><label class="form-label">Value</label><input type="text" class="form-control form-control-sm generic-value-input" value=""></div>
        </div>
        <button type="button" class="btn-close remove-item-btn" aria-label="Remove"></button>
    </div>
</template>
{% endblock %}


{% block scripts %}
    {{ super() }}
    {# Create and link a partial for the accordion sections to reduce repetition #}
    <script src="{{ url_for('static', filename='js/settings_course_configs.js') }}" defer></script>
{% endblock %}