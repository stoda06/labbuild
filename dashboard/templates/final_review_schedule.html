{# dashboard/templates/final_review_schedule.html #}
{% extends 'base.html' %}

{% block title %}Final Build Plan & Schedule{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/final_review_schedule.css') }}">
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
   <h1>Final Build Plan Review (Batch ID: {{ batch_review_id or 'N/A' }})</h1>
   <div>
        <a href="javascript:history.back()" 
           onclick="return confirm('Are you sure you want to go back? This will discard the current review state and return to the previous step.');" 
           class="btn btn-sm btn-outline-secondary">
           Back
        </a>
        <a href="{{ url_for('main.view_upcoming_courses') }}" class="btn btn-sm btn-outline-secondary ms-2">To Upcoming Courses</a>
   </div>
</div>

<div class="card">
  <div class="card-header">Consolidated Build Plan</div>
  <div class="card-body">
    {% if all_items_for_review %}
        <p>This is the final consolidated plan. Review all new builds and their generated APM credentials.</p>
        
        <div class="table-responsive">
            <table class="table table-sm table-striped table-bordered review-table" id="finalReviewTable">
                <thead class="table-light">
                    <tr>
                        <th class="col-type">Type</th>
                        <th class="col-sf-code">SF Course Code</th>
                        <th class="col-lb-course">LabBuild Course</th>
                        <th class="col-assignments">Assignments (Host: Pods)</th>
                        <th class="col-apm-user">APM User</th>
                        <th class="col-apm-pass">APM Pass</th>
                        <th class="col-status-note">Notes / Warnings</th>
                    </tr>
                </thead>
                <tbody id="finalReviewTableBody">
                    {% for item in all_items_for_review %}
                    <tr>
                        <td class="col-type">
                            {% if item.type == 'Student Build' %}<span class="badge bg-primary">{{ item.type }}</span>
                            {% elif item.type == 'Trainer Build' %}<span class="badge bg-info text-dark">{{ item.type }}</span>
                            {% else %}{{ item.type or 'N/A' }}{% endif %}
                        </td>
                        <td class="col-sf-code">{{ item.sf_course_code or 'N/A' }}</td>
                        <td class="col-lb-course">{{ item.labbuild_course or 'N/A' }}</td>
                        <td class="col-assignments">
                            {% if item.assignments %}
                                <ul>
                                {% for assign in item.assignments %}
                                    <li><strong>Host:</strong> {{ assign.host or 'N/A' }}, <strong>Pods:</strong> {{ assign.start_pod }}-{{ assign.end_pod }}</li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                <span class="text-muted">No assignments.</span>
                            {% endif %}
                        </td>
                        <td class="col-apm-user"><code>{{ item.apm_username or 'N/A' }}</code></td>
                        <td class="col-apm-pass"><code>{{ item.apm_password or 'N/A' }}</code></td>
                        <td class="col-status-note status-note-build-warning">{{ item.status_note or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-4 mb-3 pt-3">
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#emailTrainersModal"><i class="fas fa-envelope"></i> Prepare Emails</button>
            <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#apmCommandsModal"><i class="fas fa-terminal"></i> Preview APM Commands</button>
        </div>
        
        <div class="mt-4 border-top pt-3">
            <form action="{{ url_for('build_planner_actions.execute_scheduled_builds') }}" method="POST" id="executeBuildsForm">
                 <input type="hidden" name="confirmed_build_plan_data" id="confirmedBuildPlanInput" value="{{ buildable_items_json | default('[]') | escape }}">
                 <input type="hidden" name="batch_review_id" value="{{ batch_review_id or '' }}">
                 <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="perform_teardown_first" name="perform_teardown_first" value="yes">
                    <label class="form-check-label" for="perform_teardown_first">Perform Teardown Before Setup for all new builds in this batch?</label>
                 </div>
                 <div class="row align-items-end">
                    <div class="mb-3">
                     <label for="schedule_option_select" class="form-label">Scheduling Option:</label>
                     <select id="schedule_option_select" name="schedule_option" class="form-select form-select-sm" style="max-width: 200px;">
                         <option value="now" selected>Run All Now</option>
                         <option value="specific_time_all">All at Specific Time</option>
                         <option value="staggered">Staggered Start</option>
                     </select>
                    </div>
                    <div id="specific_time_all_details" style="display:none;" class="col-md-4 mb-3"><label for="schedule_start_time_all" class="form-label">Start All At (Local Time):</label><input type="datetime-local" class="form-control form-control-sm" name="schedule_start_time" id="schedule_start_time_all"></div>
                    <div id="staggered_details" style="display:none;" class="col-md-8 mb-3"><div class="row"><div class="col-md-7"><label for="schedule_start_time_staggered" class="form-label">First Job Starts At (Local Time):</label><input type="datetime-local" class="form-control form-control-sm" name="schedule_start_time_staggered" id="schedule_start_time_staggered"></div><div class="col-md-5"><label for="schedule_stagger_minutes" class="form-label">Delay (mins):</label><input type="number" class="form-control form-control-sm" name="schedule_stagger_minutes" id="schedule_stagger_minutes" value="30" min="1"></div></div></div>
                 </div>
                 <div class="mt-3">
                     <button type="submit" class="btn btn-lg btn-success"><i class="fas fa-calendar-check"></i> Confirm & Schedule Operations</button>
                    <button type="button" class="btn btn-lg btn-outline-info ms-2" data-bs-toggle="modal" data-bs-target="#labbuildCommandsModal"><i class="fas fa-eye"></i> Preview LabBuild Commands</button>
                </div>
            </form>
        </div>
    {% else %}
        <p class="p-3">No data available for final review.</p>
         <a href="{{ url_for('main.view_upcoming_courses') }}" class="btn btn-secondary m-3">Back to Upcoming Courses</a>
    {% endif %}
  </div> 
</div> 

<!-- Email Trainers Modal -->
<div class="modal fade" id="emailTrainersModal" tabindex="-1" aria-labelledby="emailTrainersModalLabel" aria-hidden="true" data-prepare-previews-url="{{ url_for('email_actions.prepare_email_previews') }}">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailTrainersModalLabel">Trainer Email Allocations</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="trainerEmailsContainer">
        <p class="text-muted">Generating email previews...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- APM Commands Modal -->
<div class="modal fade" id="apmCommandsModal" tabindex="-1" aria-labelledby="apmCommandsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="apmCommandsModalLabel">APM Commands Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="apmCommandsModalBody">
        <p class="text-muted" id="apmCommandsLoadingMsg">Click "Preview APM Commands" to generate the list.</p>
        <pre><code id="apmCommandsOutput"></code></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="copyApmCommandsBtn" title="Copy all commands to clipboard">
            <i class="fas fa-copy"></i> Copy All Commands
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- LabBuild Commands Modal -->
<div class="modal fade" id="labbuildCommandsModal" tabindex="-1" aria-labelledby="labbuildCommandsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="labbuildCommandsModalLabel">Preview LabBuild Commands</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="labbuildCommandsModalBody">
        <p class="text-muted">Generating LabBuild commands...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="copyLabbuildCommandsBtn" title="Copy all commands to clipboard">
            <i class="fas fa-copy"></i> Copy All Commands
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script id="allReviewItemsJsonData" type="application/json">
    {{ all_review_items_json | safe }}
</script>
<script id="buildableItemsJsonData" type="application/json">
  {{ buildable_items_json | default('[]') | safe }}
</script>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/final_review_schedule.js') }}" defer></script>
{% endblock %}