{# dashboard/templates/intermediate_build_review.html #}
{% extends 'base.html' %}

{% block title %}Review & Assign Student Pods{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/intermediate_build_review.css') }}">
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
   <h1>Review & Finalize Student Pod Assignments</h1>
   <a href="{{ url_for('main.view_upcoming_courses') }}" 
      onclick="return confirm('Are you sure you want to go back? Any auto-assignments for this batch will be lost.');"
      class="btn btn-sm btn-outline-secondary">
      Back to Upcoming Courses (Discard Batch)
    </a>
</div>

{% if save_error %}
    <div class="alert alert-danger" role="alert">
      <strong>Database Error:</strong> Failed to save initial review data. Please try selecting courses again.
    </div>
{% endif %}

<div class="card">
    <div class="card-header">Define Final Student Build Assignments (Batch ID: {{ batch_review_id }})</div>
    <div class="card-body">
        {% if selected_courses %}
            <p>Review {{ selected_courses|length }} course(s). Initial assignments are based on auto-allocation. Modify or add host/pod ranges as needed. "Total Est. Memory" will update.</p>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered review-table" id="studentReviewTable">
                    <thead class="table-light">
                        <tr>
                            <th class="col-sf-code">SF Course / Class #</th>
                            <th class="col-lb-course">LabBuild Course</th>
                            <th class="col-vendor">Vendor</th>
                            <th class="col-interactive-assignments">Proposed Host & Pod Assignments</th>
                            <th class="col-total-interactive-memory">Total Est. Memory (GB)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for course in selected_courses %}
                        <tr class="student-course-row" 
                            data-interim-doc-id="{{ course.interim_doc_id }}"
                            data-labbuild-course="{{ course.final_labbuild_course_student or '' }}" 
                            data-memory-one-pod="{{ course.memory_gb_one_student_pod | default(0.0) }}"
                            data-sf-course-code="{{ course.sf_course_code }}"
                            data-sf-pods-req="{{ course.effective_pods_req_student | default(1) }}" 
                            data-vendor="{{ course.vendor }}"
                            data-f5-class-number="{{ course.f5_class_number or '' }}">

                            <td class="col-sf-code">
                                {{ course.sf_course_code }}
                                {% if course.vendor == 'f5' and course.f5_class_number %}
                                    <br><small class="text-info">Class #: <strong>{{ course.f5_class_number }}</strong></small>
                                {% endif %}
                                {% if course.student_assignment_warning %}
                                <span class="assignment-warning-icon" title="{{ course.student_assignment_warning }}">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </span>
                                {% endif %}
                            </td>
                            <td class="col-lb-course">{{ course.final_labbuild_course_student or 'N/A' }}</td>
                            <td class="col-vendor">{{ course.vendor | upper if course.vendor else 'N/A' }}</td>
                            
                            <td class="col-interactive-assignments interactive-assignments-cell">
                                <div class="assignment-sub-rows-container">
                                    {% for sub_row_data in course.initial_interactive_sub_rows_student %}
                                    <div class="assignment-sub-row">
                                        <select name="host_assignment_{{ loop.index0 }}" class="form-select form-select-sm sub-host-select">
                                            <option value="">-- Host --</option>
                                            {% for host_name_opt in all_hosts %}
                                            <option value="{{ host_name_opt }}" {% if sub_row_data.host == host_name_opt %}selected{% endif %}>
                                                {{ host_name_opt }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <input type="number" name="start_pod_{{ loop.index0 }}" 
                                               class="form-control form-control-sm sub-pod-input start-pod-input" 
                                               value="{{ sub_row_data.start_pod }}" min="1" placeholder="Start">
                                        <input type="number" name="end_pod_{{ loop.index0 }}" 
                                               class="form-control form-control-sm sub-pod-input end-pod-input" 
                                               value="{{ sub_row_data.end_pod }}" min="1" placeholder="End">
                                        <div class="sub-row-actions">
                                            <button type="button" class="btn remove-assignment-btn" title="Remove this assignment segment"><i class="fa-solid fa-circle-xmark"></i></button>
                                            <button type="button" class="btn add-assignment-btn-inline" title="Add another assignment segment"><i class="fa-solid fa-circle-plus"></i></button>
                                        </div>
                                    </div>
                                    {% else %}
                                        <div class="text-muted small">No assignments proposed. Please add one.</div>
                                        <button type="button" class="btn btn-sm btn-outline-success add-assignment-btn-main mt-1" title="Add first assignment">
                                            <i class="fa-solid fa-circle-plus me-1"></i>Add Assignment Segment
                                        </button>
                                    {% endfor %}
                                </div> 
                            </td>
                            <td class="col-total-interactive-memory text-end">
                                <span class="total-course-memory-display">0.00</span> GB
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-4">
                <form action="{{ url_for('build_planner_actions.prepare_trainer_pods') }}" method="POST" id="confirmStudentAssignmentsForm">
                     <input type="hidden" name="final_build_plan" id="finalStudentBuildPlanInput">
                     <input type="hidden" name="batch_review_id" value="{{ batch_review_id }}">
                     <button type="submit" class="btn btn-lg btn-success" 
                             title="Finalize assignments and proceed to trainer pod allocation.">
                         <i class="fas fa-arrow-right"></i> Confirm & Proceed
                     </button>
                     <a href="{{ url_for('main.view_upcoming_courses') }}" 
                        onclick="return confirm('Are you sure you want to cancel? All proposed assignments will be discarded.');"
                        class="btn btn-lg btn-secondary ms-2">
                        Cancel Batch
                    </a>
                </form>
            </div>

        {% else %}
            <div class="alert alert-warning"> No courses were processed. Please go back and select courses. </div>
             <a href="{{ url_for('main.view_upcoming_courses') }}" class="btn btn-secondary">Back to Upcoming Courses</a>
        {% endif %}
    </div> 
</div> 

{# Embedded data for JavaScript #}
<script id="allHostsDataStudentReview" type="application/json">
    {{ all_hosts | tojson | safe }}
</script>
<script id="courseMemoryDataStudentReview" type="application/json">
    {{ course_configs_for_memory | tojson | safe }}
</script>
<script id="memoryFactorDataStudentReview" type="application/json">
    {{ {"factor": subsequent_pod_memory_factor} | tojson | safe }}
</script>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/intermediate_build_review.js') }}" defer></script>
{% endblock %}